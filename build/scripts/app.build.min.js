"use strict";var app=angular.module("app",["ui.router","ngResource","ngTouch","hmTouchEvents","app.stack"]);app.config(function($stateProvider,$locationProvider,$resourceProvider,$urlRouterProvider){$stateProvider.state("home",{url:"/home"}).state("home.now",{url:"/now",title:"Read now"}).state("home.want",{url:"/want",title:"Want to read"}).state("home.all",{url:"/all",title:"All books"}).state("home.quotes",{url:"/quotes",title:"Quotes"}).state("catalog",{url:"/catalog"}).state("catalog.all",{url:"/all",title:"Catalog"}).state("catalog.friends",{url:"/friends",title:"Friends"}).state("catalog.popular",{url:"/popular",title:"Popular"}).state("catalog.shelves",{url:"/shelves",title:"Shelves"}),$urlRouterProvider.otherwise("/home/now"),$locationProvider.html5Mode(!0),$resourceProvider.defaults.stripTrailingSlashes=!0}),app.controller("AppCtrl",["$rootScope","$scope","$state","BookListsResource",function($rootScope,$scope,$state,BookListsResource){$scope.app={$state:$state,savedState:{home:"home.now",catalog:"catalog.all"},initialize:function(){this.setBookLists()},getCurrentTitle:function(){return this.$state.current.title},getCurrentStateName:function(){return this.$state.current.name},getCurrentSplitStateName:function(){return this.getCurrentStateName().replace("."," ")},getCurrentParentStateName:function(){return this.$state.$current.parent.name},goToState:function(state){this.savedState[this.getCurrentParentStateName()]=state,this.$state.go(state)},toggleParentState:function(){"home"===this.getCurrentParentStateName()?this.$state.go(this.savedState.catalog):this.$state.go(this.savedState.home)},setBookLists:function(){this.bookLists=[]},fetchBookLists:function(){BookListsResource.query(function(res){console.log("booklists:",res)})}},$scope.app.initialize(),console.log("state:",$scope.app.$state)}]),app.stack=angular.module("app.stack",[]);var hmTouchEvents=angular.module("hmTouchEvents",[]),hmGestures=["hmPan:pan","hmPanStart:panstart","hmPanMove:panmove","hmPanEnd:panend","hmPanCancel:pancancel","hmPanLeft:panleft","hmPanRight:panright","hmPanUp:panup","hmPanDown:pandown","hmSwipe:swipe","hmSwipeLeft:swipeleft","hmSwipeRight:swiperight","hmSwipeUp:swipeup","hmSwipeDown:swipedown"];angular.forEach(hmGestures,function(name){var directive=name.split(":"),directiveName=directive[0],eventName=directive[1];hmTouchEvents.directive(directiveName,["$parse",function($parse){return{scope:!0,link:function(scope,element,attr){var fn,opts;return fn=$parse(attr[directiveName]),opts=$parse(attr.hmOptions)(scope,{}),scope.hammer=opts&&opts.group?scope.hammer||Hammer(element[0],opts):Hammer(element[0],opts),scope.hammer.on(eventName,function(event){return scope.$apply(function(){return fn(scope,{$event:event})})})}}}])}),app.stack.controller("StackCtrl",["$rootScope","$scope","$state","UserBookListReadNowResource",function($rootScope,$scope,$state,UserBookListReadNowResource){$scope.stack={distance:0,currentBook:null,animatedBook:null,firstBookShowed:!0,initialize:function(){this.setEventListeners(),this.fetchUserBookListReadNow()},setEventListeners:function(){$scope.$on("stack:nextBookShown",this.setDefaultStateAfterNextBookShown.bind(this)),$scope.$on("stack:previousBookShown",this.setDefaultStateAfterPreviousBookShown.bind(this)),$scope.$on("stack:nextBookHidden",this.setDefaultStateAfterNextBookHidden.bind(this)),$scope.$on("stack:previousBookHidden",this.setDefaultStateAfterPreviousBookHidden.bind(this))},setUserBookListReadNow:function(res){this.userBookListReadNow=res,this.currentBookList=this.userBookListReadNow,this.setCurrentBook(),this.setAnimatedBook(this.currentBook)},setCurrentBook:function(book){this.currentBook=book||this.currentBookList[0],this._setNextBook(),this._setPreviousBook()},setAnimatedBook:function(book){this.animatedBook=book||this.currentBook},_setNextBook:function(){var nextIndex=this.currentBookList.indexOf(this.currentBook)+1;this.nextBook=nextIndex<=this.currentBookList.length-1?this.currentBookList[nextIndex]:null},_setPreviousBook:function(){var previousIndex=this.currentBookList.indexOf(this.currentBook)-1;this.previousBook=previousIndex>=0?this.currentBookList[previousIndex]:null},setDefaultStateAfterNextBookShown:function(){this.setAnimatedBook(this.currentBook),this.cleanDistance(),this._setDefaultValues()},setDefaultStateAfterNextBookHidden:function(){this.setCurrentBook(this.animatedBook),this.cleanDistance(),this._setDefaultValues()},setDefaultStateAfterPreviousBookShown:function(){this.setCurrentBook(this.animatedBook),this.setAnimatedBook(this.currentBook),this.cleanDistance(),this._setDefaultValues(),$scope.$apply()},setDefaultStateAfterPreviousBookHidden:function(){this.setAnimatedBook(this.currentBook),this.cleanDistance(),this._setDefaultValues()},_setDefaultValues:function(){this.bookShowingPartially=!1,this.bookShowingFully=!1,this.firstBookShowed=!1,this.lastBookShowed=!this.nextBook,this.firstBookShowed=!this.previousBook},fetchUserBookListReadNow:function(){UserBookListReadNowResource.query().$promise.then(this.setUserBookListReadNow.bind(this))},getNextBookFully:function($event){if(this.bookShowingFully=!0,!this.isBookShowingPartially()){if(!this.nextBook)return;this.setCurrentBook(this.nextBook)}this._broadcastShowNextBookFully($event)},getPreviousBookFully:function($event){if(this.bookShowingFully=!0,!this.isBookShowingPartially()){if(!this.previousBook)return;this.setAnimatedBook(this.previousBook)}this._broadcastShowPreviousBookFully($event)},getBookPartially:function($event){return this.isBookShowingFully()?(this.cleanDistance(),void 0):(this.distance=this.distance?this.distance+$event.deltaX:$event.deltaX,this.distance<0?this.getNextBookPartially($event):this.distance>0&&this.getPreviousBookPartially($event),void 0)},getNextBookPartially:function($event){return!this.nextBook&&this.isLastBookShowed()?(this.cleanDistance(),void 0):(this.isBookShowingPartially()||(this.bookShowingPartially=!0,this.setCurrentBook(this.nextBook)),this._broadcastShowNextBookPartially($event),console.log("getNextBookPartially"),void 0)},getPreviousBookPartially:function($event){return console.log("1",!this.previousBook),console.log("2",this.isFirstBookShowed()),!this.previousBook&&this.isFirstBookShowed()?(this.cleanDistance(),void 0):(console.log("getPreviousBookPartially"),this.isBookShowingPartially()||(this.bookShowingPartially=!0,this.setAnimatedBook(this.previousBook)),this._broadcastShowPreviousBookPartially($event),void 0)},endGetBookPartially:function($event){this.isBookShowingPartially()&&this._broadcastEndShowBookPartially($event,this.distance)},cleanDistance:function(){this.distance=0},isBookShowingFully:function(){return this.bookShowingFully},isLastBookShowed:function(){return this.lastBookShowed},isFirstBookShowed:function(){return this.firstBookShowed},isBookShowingPartially:function(){return this.bookShowingPartially},_broadcastShowNextBookFully:function($event){$scope.$broadcast("stack:showNextBookFully",$event)},_broadcastShowNextBookPartially:function($event){$scope.$broadcast("stack:showNextBookPartially",$event)},_broadcastShowPreviousBookFully:function($event){$scope.$broadcast("stack:showPreviousBookFully",$event)},_broadcastShowPreviousBookPartially:function($event){$scope.$broadcast("stack:showPreviousBookPartially",$event)},_broadcastEndShowBookPartially:function($event,distance){$scope.$broadcast("stack:endShowBookPartially",$event,distance)}},$scope.stack.initialize()}]),app.stack.directive("stack",["$rootScope","$state","$window",function($rootScope,$state,$window){return{restrict:"E",controller:"StackCtrl",link:function(scope){scope.stack.view={elWidth:308,defaultDuration:500,initialize:function(){this.setEventListeners()},setEventListeners:function(){scope.$on("stack:showNextBookFully",this.showNextBookCardFully.bind(this)),scope.$on("stack:showNextBookPartially",this.showNextBookCardPartially.bind(this)),scope.$on("stack:showPreviousBookFully",this.showPreviousBookCardFully.bind(this)),scope.$on("stack:showPreviousBookPartially",this.showPreviousBookCardPartially.bind(this)),scope.$on("stack:endShowBookPartially",this.endShowBookCardPartially.bind(this))},getWindowWidth:function(){return this.windowWidth||(this.windowWidth=$window.innerWidth),this.windowWidth},getCurrentLeftValue:function(){var animatedBookCard=this.getAnimatedBookCard();return this.isShowingPartially()?parseInt(animatedBookCard.el.style.left):animatedBookCard.defaultLeftValue},getCurrentLeftDifferenceValue:function(){var animatedBookCard=this.getAnimatedBookCard();return Math.abs(Math.abs(animatedBookCard.defaultLeftValue)-Math.abs(this.getCurrentLeftValue()))},getAnimatedBookCard:function(){return this.animatedBookCard||(this.animatedBookCard={},this.animatedBookCard.el=document.getElementById("animated-book-card"),this.animatedBookCard.defaultLeft=$window.getComputedStyle(this.animatedBookCard.el).left,this.animatedBookCard.defaultLeftValue=this.animatedBookCard.defaultLeft.indexOf("%")?this.getWindowWidth()*parseInt(this.animatedBookCard.defaultLeft)/100:parseInt(this.animatedBookCard.defaultLeft),this.animatedBookCard.endLeft=-1*this.getWindowWidth()+this.animatedBookCard.defaultLeftValue+"px",this.animatedBookCard.endLeftValue=parseInt(this.animatedBookCard.endLeft),this.animatedBookCard.width=this.elWidth),this.animatedBookCard},activateAnimatedBookCard:function(){this.active||(this.active=!0,this.getAnimatedBookCard().el.style.display="inline-block")},deactivateAnimatedBookCard:function(){this.active&&(this.active=!1,this.getAnimatedBookCard().el.style.display="none")},setAnimatedBookCardToDefaultState:function(){this.deactivateAnimatedBookCard(),this.getAnimatedBookCard().el.style.left=""},setAnimatedBookCardToEndState:function(){this.getAnimatedBookCard().el.style.left=this.getAnimatedBookCard().endLeft,this.activateAnimatedBookCard()},showNextBookCardFully:function(){console.log("showNextBookCardFully"),this.activateAnimatedBookCard(),this.bookCardShowingFully=!0;var animatedBookCard=this.getAnimatedBookCard();Velocity(animatedBookCard.el,{left:animatedBookCard.endLeft},{display:"inline-block",duration:200,promise:!0,complete:function(){this._broadcastNextBookShown(),this.setAnimatedBookCardToDefaultState(),this.bookCardShowingFully=!1}.bind(this)}),this.bookCardShowingPartially=!1},showNextBookCardPartially:function(e,$event){if(!this.isShowingFully()){this.activateAnimatedBookCard(),this.bookCardShowingPartially=!0;var animatedBookCard=this.getAnimatedBookCard(),distance=Math.min(animatedBookCard.defaultLeftValue+$event.deltaX,animatedBookCard.defaultLeftValue);Velocity(animatedBookCard.el,{left:distance},{display:"inline-block",duration:0,promise:!0})}},hideNextBookCardFully:function(){if(this.isShowingPartially()){var animatedBookCard=this.getAnimatedBookCard();Velocity(animatedBookCard.el,{left:animatedBookCard.defaultLeftValue},{display:"inline-block",duration:200,promise:!0,complete:function(){this.bookCardShowingPartially=!1,this._broadcastNextBookHidden()}.bind(this)})}},showPreviousBookCardFully:function(){console.log("showPreviousBookCardFully"),this.isShowingPartially()||this.setAnimatedBookCardToEndState(),this.bookCardShowingFully=!0;var animatedBookCard=this.getAnimatedBookCard();Velocity(animatedBookCard.el,{left:animatedBookCard.defaultLeft},{display:"inline-block",duration:200,promise:!0,complete:function(){this._broadcastPreviousBookShown(),this.setAnimatedBookCardToDefaultState(),this.bookCardShowingFully=!1}.bind(this)}),this.bookCardShowingPartially=!1},showPreviousBookCardPartially:function(e,$event){if(console.log("showPreviousBookCardPartially"),!this.isShowingFully()){this.isShowingPartially()||this.setAnimatedBookCardToEndState(),this.bookCardShowingPartially=!0;var animatedBookCard=this.getAnimatedBookCard(),distance=Math.max(animatedBookCard.endLeftValue+$event.deltaX,animatedBookCard.endLeftValue);Velocity(animatedBookCard.el,{left:distance},{display:"inline-block",duration:0,promise:!0})}},hidePreviousBookCardFully:function(){if(this.isShowingPartially()){var animatedBookCard=this.getAnimatedBookCard();Velocity(animatedBookCard.el,{left:animatedBookCard.endLeftValue},{display:"inline-block",duration:200,promise:!0,complete:function(){this.bookCardShowingPartially=!1,this.setAnimatedBookCardToDefaultState(),this._broadcastPreviousBookHidden()}.bind(this)}),console.log("hidePreviousBookCardFully")}},endShowBookCardPartially:function(e,$event,distance){if(!this.isShowingFully()){var diff=this.getCurrentLeftDifferenceValue(),minDistance=this.getWindowWidth()/3;(0>distance?minDistance>diff:diff>minDistance)?0>distance?this.hideNextBookCardFully():this.hidePreviousBookCardFully():0>distance?this.showNextBookCardFully():this.showPreviousBookCardFully()}},isShowingFully:function(){return this.bookCardShowingFully},isShowingPartially:function(){return this.bookCardShowingPartially},_broadcastNextBookShown:function(){scope.$broadcast("stack:nextBookShown")},_broadcastPreviousBookShown:function(){scope.$broadcast("stack:previousBookShown")},_broadcastNextBookHidden:function(){scope.$broadcast("stack:nextBookHidden")},_broadcastPreviousBookHidden:function(){scope.$broadcast("stack:previousBookHidden")}},scope.stack.view.initialize()}}}]),app.stack.factory("BookListsResource",["$resource",function($resource){return $resource(CONFIG.api.href+"/a/4/lists.json",{auth_token:CONFIG.api.token})}]).factory("UserBookListReadNowResource",["$resource",function($resource){return $resource(CONFIG.api.href+"/a/4/u/"+CONFIG.api.login+"/d/now_reading.json")}]).factory("UserBookListReadWantResource",["$resource",function($resource){return $resource(CONFIG.api.href+"/a/4/u/"+CONFIG.api.login+"/d/read_later.json")}]).factory("UserBookListAllResource",["$resource",function($resource){return $resource(CONFIG.api.href+"/a/4/u/"+CONFIG.api.login+"/d/all.json")}]);